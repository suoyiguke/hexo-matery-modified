---
title: mysql-主从复制日常维护工作1主从复制之手动强制同步.md
top: false
cover: false
toc: true
mathjax: true
date: 2022-03-20 18:16:49
password:
summary:
tags: mysql运维操作
categories: mysql运维操作
---
---
title: mysql-主从复制日常维护工作1主从复制之手动强制同步.md
top: false
cover: false
toc: true
mathjax: true
date: 2022-03-20 18:16:49
password:
summary:
tags: mysql运维操作
categories: mysql运维操作
---
在某些繁忙的 OLTP(在线事务处理）系统上，由于主库更新频繁，而从库由于各种原因(比如硬件性能较差）导致更新速度较慢，从而使得主从库之间的数据差距越来越大，最终对某些应用产生影响。在这种情况下，我们就需要定期地进行主从库的数据同步，使得主从数据差距能够减到最小。常用的方法是:在负载较低时暂时阻塞主数据库的更新，强制主从数据库更新同步。具体操作步骤如下。
1、在主库上，执行以下语句（注意，会阻塞主数据库的所有更新操作):
~~~
mysq1> FLUSH TABLES WITH READ LOCK;
Query OK,0 rows affected (0.01 sec)
mysql> show master status;
+------------------+----------+--------------+------------------+-------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
+------------------+----------+--------------+------------------+-------------------+
| mysql-bin.000002 | 15307388 | test         | mysql            |                   |
+------------------+----------+--------------+------------------+-------------------+
1 row in set (0.00 sec)
~~~
记录SHOW语句的输出的日志名和偏移量，这些是从库复制的目的坐标。

2、在从库上，执行下面的语句，其中MASTER_POS_WAIT()函数的参数是前面步骤中得到的复制坐标值:
~~~
select MASTER_POS_WAIT('mysql-bin.000002','15307388');
~~~
这个函数MASTER_POS_WAIT会阻塞下去，直到从库同步了主库的数据才会正常返回结果；
可以根据它的执行时间来得到`从库追上主库的时间`

3、在主库上，执行下面的语句允许主库重新开始处理更新:
~~~
mysq1s UNLOCK TABLES;
Query OK,orows affected (o.00 sec)
~~~


**从库重启后会自动会同步之前没有同步到的数据**
按照我的实验，处于正常主从同步状态下，将从库mysql服务停止。同时主库继续插入数据，然后再次启动从库，可以发现从库自动地同步了之前插入的数据。


那么MASTER_POS_WAIT()函数又有什么用呢？
按理说mysql从机重启后也会自动同步之前落掉的数据。但是由于从机机器性能差或者网络原因主从之间数据差异还是过大。这个时候我们就需要使用 MASTER_POS_WAIT函数了。它 对于控制源/副本同步非常有用。它会一直阻塞，直到复制副本读取并应用了源日志中指定位置的所有更新。返回值是副本必须等待才能前进到指定位置的日志事件数。
- 如果副本SQL线程未启动、副本的源信息未初始化、参数不正确或出现错误，该函数将返回空值。
- 如果超时，它将返回-1。
- 如果副本SQL线程在 MASTER_POS_WAIT()等待时停止，该函数返回空值。
- 如果副本超过了指定位置，该函数将立即返回。 

在多线程副本上，当调用检查点操作来更新副本的状态时，该函数会一直等待，直到从属检查点组或从属检查点周期系统变量设置的限制到期。根据系统变量的设置，函数可能会在到达指定位置后一段时间返回。 如果指定了超时值，当超时秒数过去时，主机停止等待。超时必须大于0；零或负超时意味着没有超时。

>此函数对于基于语句的复制不安全。当binlog_format设置为STATEMENT时，如果使用此函数，将记录一条警告。

**提出一个问题**
MASTER_POS_WAIT是用来在从库上执行，强制同步主库数据的；但是设想一下若从库数据落后主库长时间(超过主库binlog过期时间)那么此函数还能强制同步到主库的数据么？
经过我的实验，我将主库binlog删除。主从同步立马报错Got fatal error 1236 from master when reading data from binary log: 'Could not find first log file name in binary log index file'
>所以说若长时间没有同步，需要使用其他工具或导出全备应用到从库了，导入时注意需要禁止生成binlog。


**从库同步数据比主库直接执行慢多少？**
按照我的测试，从库同步耗时将是主库直接执行的3倍！
测试主库直接执行200秒。而从库需要600秒才同步完成。
